<script src="{{ base_path }}/assets/js/main.min.js"></script>

<!-- Fix greedy-nav to preserve .persist items (like theme toggle) -->
<script>
(function() {
  var $nav = $('#site-nav');
  var $btn = $('#site-nav button');
  var $vlinks = $('#site-nav .visible-links');
  var $hlinks = $('#site-nav .hidden-links');
  var breaks = [];

  function updateNav() {
    var availableSpace = $btn.hasClass('hidden') ? $nav.width() : $nav.width() - $btn.width() - 30;

    if($vlinks.width() > availableSpace) {
      breaks.push($vlinks.width());
      // Exclude .persist items from being moved to hidden menu
      $vlinks.children('*:not(.masthead__menu-item--lg):not(.persist)').last().prependTo($hlinks);
      if($btn.hasClass('hidden')) {
        $btn.removeClass('hidden');
      }
    } else {
      if(availableSpace > breaks[breaks.length-1]) {
        $hlinks.children().first().appendTo($vlinks);
        breaks.pop();
      }
      if(breaks.length < 1) {
        $btn.addClass('hidden');
        $hlinks.addClass('hidden');
      }
    }
    $btn.attr("count", breaks.length);
    if($vlinks.width() > availableSpace) {
      updateNav();
    }
  }

  function initNav() {
    // First, rescue any .persist items that were moved to hidden-links by the original script
    $hlinks.children('.persist').appendTo($vlinks);

    // Reset breaks array and recalculate
    breaks = [];
    var hiddenCount = $hlinks.children().length;

    // Rebuild breaks array based on items in hidden-links
    for (var i = 0; i < hiddenCount; i++) {
      breaks.push(0); // Placeholder values
    }

    // Update button visibility
    if (hiddenCount > 0) {
      $btn.removeClass('hidden');
      $btn.attr("count", hiddenCount);
    } else {
      $btn.addClass('hidden');
      $hlinks.addClass('hidden');
    }
  }

  // Override the default updateNav
  $(window).off('resize').resize(function() {
    updateNav();
  });

  // Re-run on load - first rescue persist items, then update
  $(document).ready(function() {
    initNav();
    updateNav();
  });
})();
</script>

{% include analytics.html %}
